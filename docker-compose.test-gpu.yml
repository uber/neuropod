# A separate docker-compose file for GPU because the buildkite agents
# for CPU builds use an older version of docker-compose.
# This file will be merged into `docker-compose.test.yml` once the build
# agents are updated.
version: '2.3'
services:
  test-gpu:
    build:
      context: .
      dockerfile: build/neuropods.dockerfile
      target: neuropod-build
      args:
        NEUROPODS_IS_GPU: "true"
    privileged: true
    runtime: nvidia

  test-gpu-variant-1:
    extends: test-gpu
    build:
      args:
        NEUROPODS_CUDA_VERSION: 9.0
        NEUROPODS_TENSORFLOW_VERSION: 1.11.0
        NEUROPODS_TORCH_VERSION: 1.1.0

  test-gpu-variant-2:
    extends: test-gpu
    build:
      args:
        NEUROPODS_CUDA_VERSION: 9.0
        NEUROPODS_TENSORFLOW_VERSION: 1.12.0
        NEUROPODS_TORCH_VERSION: 1.2.0.dev20190601

  test-gpu-variant-3:
    extends: test-gpu
    build:
      args:
        NEUROPODS_CUDA_VERSION: 10.0
        NEUROPODS_TENSORFLOW_VERSION: 1.13.1
        # CUDA 10 nightly builds don't currently work for torch so we're using the
        # latest stable version
        NEUROPODS_TORCH_VERSION: 1.1.0
